<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VisualBoard Enhanced Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leader-line-new/leader-line.min.js"></script>
<style>
body { margin:0; font-family:sans-serif; display:flex; height:100vh; overflow:hidden; }
aside { width:250px; background:#fff; padding:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); overflow-y:auto; }
main { flex:1; overflow:auto; position:relative; background:#f0f0f0; }
.board { width:2000px; height:1500px; position:relative; }
.note { position:absolute; width:250px; min-height:150px; background:#fff; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.2); display:flex; flex-direction:column; }
.note-header { display:flex; justify-content:space-between; align-items:center; padding:4px; background:#eee; cursor:move; border-radius:6px 6px 0 0; }
.note-toolbar { display:flex; gap:2px; padding:2px 4px; background:#f9f9f9; flex-wrap:wrap; font-size:12px; }
.note-content { flex:1; padding:4px; overflow:auto; min-height:50px; outline:none; }
.preview { margin-top:4px; padding:4px; background:#f9f9f9; border:1px solid #ccc; border-radius:4px; font-size:12px; }
.folder { padding:4px; cursor:pointer; border-radius:4px; margin-bottom:4px; }
.folder:hover { background:#e0e7ff; }
</style>
</head>
<body>

<aside>
<h2 class="font-bold mb-2">Boards</h2>
<div id="folders"></div>
<button id="addFolder" class="mt-2 p-2 bg-indigo-600 text-white rounded">+ Board</button>
<button id="saveBtn" class="mt-2 p-2 bg-green-600 text-white rounded">ðŸ’¾ Save</button>
<button id="loadBtn" class="mt-2 p-2 bg-yellow-600 text-white rounded">ðŸ“‚ Load</button>
</aside>

<main>
<div style="margin:10px 0;">
<button id="addNote">+ Note</button>
<button id="connectorToggle">Connector</button>
<input type="color" id="arrowColor" title="Arrow Color" value="#ff0000">
<select id="arrowType">
<option value="straight">Straight</option>
<option value="dotted">Dotted</option>
<option value="arrow-small">Small Arrow</option>
</select>
</div>
<div id="boardContainer"></div>
</main>

<script>
const BIN_ID = '68c053e6d0ea881f40779ed8';
const SECRET_KEY = ''; // add key if private bin

let boards = {};
let activeBoard = null;
let firstNote = null;
let connectorMode = false;
let scale = 1;

// Board creation
function createBoard(name){
  if(boards[name]) return;
  const board=document.createElement('div'); board.className='board'; board.style.display='none';
  boards[name]={element:board, connections:[]};
  document.getElementById('boardContainer').appendChild(board);
}

// Switch board
function switchBoard(name){
  if(activeBoard) activeBoard.element.style.display='none';
  activeBoard = boards[name];
  activeBoard.element.style.display='block';
}

// Add note
function addNote(text='', x=50, y=50, bg='#fff'){
  if(!activeBoard) return alert('Select a board');
  const note=document.createElement('div'); note.className='note';
  note.style.left=x+'px'; note.style.top=y+'px'; note.style.backgroundColor=bg;

  note.innerHTML=`
  <div class="note-header">
    <span>Note</span>
    <div>
      <button class="minimize-btn">_</button>
      <input type="color" class="note-bg-picker" value="${bg}" title="Background Color">
    </div>
  </div>
  <div class="note-toolbar">
    <button onclick="execCmd(this,'bold')"><b>B</b></button>
    <button onclick="execCmd(this,'italic')"><i>I</i></button>
    <button onclick="execCmd(this,'underline')"><u>U</u></button>
    <button onclick="execCmd(this,'insertUnorderedList')">â€¢ List</button>
    <button onclick="execCmd(this,'insertOrderedList')">1. List</button>
    <button onclick="insertLink()">Link</button>
    <select onchange="execCmd(this,'fontSize',this.value)">
      <option value="3">Normal</option>
      <option value="4">Medium</option>
      <option value="5">Large</option>
    </select>
    <input type="color" onchange="execCmd(this,'foreColor',this.value)" title="Text Color">
  </div>
  <div class="note-content" contenteditable="true">${text}</div>
  <div class="preview"></div>
  `;

  activeBoard.element.appendChild(note);

  const header = note.querySelector('.note-header');
  interact(note).draggable({
    allowFrom: header,
    listeners:{ move: dragMoveListener }
  }).resizable({
    edges:{left:true,right:true,bottom:true,top:true},
    listeners:{ move: resizeMoveListener }
  });

  const minimizeBtn = note.querySelector('.minimize-btn');
  const contentDiv = note.querySelector('.note-content');
  const toolbar = note.querySelector('.note-toolbar');
  minimizeBtn.onclick=()=>{
    if(contentDiv.style.display==='none'){ contentDiv.style.display='block'; toolbar.style.display='flex'; }
    else{ contentDiv.style.display='none'; toolbar.style.display='none'; }
  }

  const colorPicker = note.querySelector('.note-bg-picker');
  colorPicker.oninput=(e)=>note.style.backgroundColor=e.target.value;

  note.onclick=()=>handleConnectorClick(note);

  contentDiv.addEventListener('input',()=>generatePlaceholderPreview(contentDiv,note.querySelector('.preview')));
  generatePlaceholderPreview(contentDiv,note.querySelector('.preview'));
}

// Rich text commands
function execCmd(el,cmd,val=null){ document.execCommand(cmd,false,val); }
function insertLink(){ const url=prompt('Enter URL'); if(url) document.execCommand('createLink',false,url); }

// Drag and resize listeners
function dragMoveListener(event){
  const target=event.target;
  const x=(parseFloat(target.getAttribute('data-x'))||0)+event.dx/scale;
  const y=(parseFloat(target.getAttribute('data-y'))||0)+event.dy/scale;
  target.style.transform=`translate(${x}px,${y}px)`;
  target.setAttribute('data-x',x); target.setAttribute('data-y',y);
  activeBoard.connections.forEach(c=>c.position());
}
function resizeMoveListener(event){
  const target=event.target;
  let w=parseFloat(target.style.width)||target.offsetWidth;
  let h=parseFloat(target.style.height)||target.offsetHeight;
  w+=event.deltaRect.width;
  h+=event.deltaRect.height;
  target.style.width=w+'px'; target.style.height=h+'px';
}

// Placeholder URL preview
function generatePlaceholderPreview(contentDiv,preview){
  const urlRegex=/(https?:\/\/[^\s]+)/g;
  const urls=contentDiv.innerText.match(urlRegex);
  preview.innerHTML='';
  if(urls) urls.forEach(url=>{
    const div=document.createElement('div');
    div.innerHTML=`<strong>Preview Title</strong><br>${url}<br><em>Placeholder description</em>`;
    preview.appendChild(div);
  });
}

// Connector mode (straight arrows only)
function handleConnectorClick(note){
  if(!connectorMode) return;
  if(!firstNote){ firstNote=note; note.style.border='2px dashed red'; }
  else{
    const color=document.getElementById('arrowColor').value||'red';
    const type=document.getElementById('arrowType').value;
    const opts={color:color, path:'straight', startPlug:type.includes('arrow')?'disc':null};
    const line=new LeaderLine(firstNote,note,opts);
    activeBoard.connections.push(line);
    firstNote.style.border=''; firstNote=null;
  }
}

// Zoom
document.addEventListener('wheel',e=>{
  if(e.ctrlKey){ e.preventDefault(); scale+=e.deltaY<0?0.05:-0.05; scale=Math.min(Math.max(scale,0.5),3);
    if(activeBoard) activeBoard.element.style.transform=`scale(${scale})`; }
},{passive:false});

// Folder buttons
document.getElementById('addFolder').onclick=()=>{
  const name=prompt('Board name:'); if(!name) return;
  createBoard(name);
  const folder=document.createElement('div'); folder.className='folder'; folder.textContent=name;
  folder.onclick=()=>switchBoard(name);
  document.getElementById('folders').appendChild(folder);
  switchBoard(name);
};

// Other buttons
document.getElementById('addNote').onclick=()=>addNote();
document.getElementById('connectorToggle').onclick=()=>{connectorMode=!connectorMode; alert('Connector mode: '+connectorMode);}

// JSONBin Integration
async function saveBoards(){
  const boardsData={};
  Object.keys(boards).forEach(name=>{
    const b=boards[name];
    boardsData[name]={ notes:Array.from(b.element.querySelectorAll('.note')).map(n=>({
      html:n.querySelector('.note-content').innerHTML,
      x:parseFloat(n.getAttribute('data-x'))||0,
      y:parseFloat(n.getAttribute('data-y'))||0,
      bg:n.style.backgroundColor||'#fff'
    }))};
  });
  await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`,{
    method:'PUT',
    headers:{ 'Content-Type':'application/json', 'X-Master-Key':SECRET_KEY, 'X-Bin-Versioning':'false' },
    body:JSON.stringify({boards:boardsData})
  });
  alert('Saved!');
}

async function loadBoards(){
  const res=await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`,{
    headers:{ 'X-Master-Key': SECRET_KEY }
  });
  const data=await res.json();
  const boardsData=data.record.boards||{};
  document.getElementById('boardContainer').innerHTML='';
  document.getElementById('folders').innerHTML='';
  boards={}; activeBoard=null;
  Object.keys(boardsData).forEach(name=>{
    createBoard(name);
    const folder=document.createElement('div'); folder.className='folder'; folder.textContent=name;
    folder.onclick=()=>switchBoard(name); document.getElementById('folders').appendChild(folder);
    switchBoard(name);
    boardsData[name].notes.forEach(n=>addNote(n.html,n.x,n.y,n.bg));
  });
}

document.getElementById('saveBtn').onclick=saveBoards;
document.getElementById('loadBtn').onclick=loadBoards;

</script>
</body>
</html>
