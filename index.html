<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Shared Article Board</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="https://unpkg.com/feather-icons"></script>

<!-- Favicon -->
<link rel="icon" type="image/png" href="https://content.mycutegraphics.com/graphics/hearts/pink-heart.png" />

<style>
  body { background-color: #fdf6e3; }
  .article-card { transition: all 0.3s ease; }
  .article-card:hover { transform: translateY(-4px); box-shadow: 0 8px 18px -5px rgba(0,0,0,0.12); }
  .add-article-btn { transition: all 0.3s ease; }
  .add-article-btn:hover { transform: scale(1.03); }
  .dragging { opacity: 0.5; outline: 2px dashed rgba(79,70,229,0.75); transform: scale(0.98); }
  .drag-over { border: 2px dashed rgba(16,185,129,0.9); background-color: #ecfdf5; }
  .article-image { aspect-ratio: 2 / 3; }
  .article-snippet { color: #4B5563; font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
  .tab-btn { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.5rem; position: relative; display: flex; align-items: center; margin: 4px; background: #e5e7eb; }
  .tab-btn.active { background-color: #6366F1; color: white; }
  .tab-controls { display: none; margin-left: 6px; }
  .tab-btn:hover .tab-controls { display: inline-flex; }
  .tab-controls button { margin-left: 4px; padding: 0 6px; border-radius: 4px; font-size: 0.75rem; background: rgba(255,255,255,0.85); color: #1f2937; border: 1px solid rgba(0,0,0,0.06); }
  .tab-controls button:hover { background: rgba(255,255,255,0.98); }
</style>
</head>
<body class="min-h-screen">

<div class="container mx-auto px-4 py-8">
  <header class="mb-6 text-center">
    <h1 class="text-3xl font-bold text-indigo-800 mb-1">Shared Article Board</h1>
    <p class="text-sm text-gray-600">Articles are synced via JSONBin.io</p>
  </header>

  <!-- Tabs / Rooms -->
  <div class="flex justify-center mb-4 flex-wrap items-center" id="tabs-container"></div>

  <div class="flex justify-center mb-6 space-x-2">
    <button onclick="addNewRoom()" class="flex items-center bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-full shadow-md text-sm">
      <i data-feather="plus" class="mr-1"></i> New Room
    </button>

    <button onclick="openModal()" class="add-article-btn flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-full shadow-md text-sm">
      <i data-feather="plus" class="mr-2"></i> Add New Article
    </button>
  </div>

  <div id="articles-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>

  <div id="empty-state" class="text-center py-20 hidden">
    <i data-feather="file-text" class="w-12 h-12 mx-auto text-gray-400 mb-3"></i>
    <h3 class="text-lg font-medium text-gray-600">No articles yet</h3>
    <p class="text-gray-500 mt-1 text-sm">Add your first article to get started</p>
  </div>
</div>

<!-- Add/Edit Modal -->
<div id="add-article-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-gray-100 rounded-lg p-6 w-full max-w-md shadow-md">
    <div class="flex justify-between items-center mb-4">
      <h3 id="modal-title" class="text-lg font-semibold text-gray-800">Add New Article</h3>
      <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700"><i data-feather="x"></i></button>
    </div>
    <form id="article-form" class="space-y-3 text-sm">
      <div>
        <label for="article-image" class="block font-medium mb-1 text-gray-700">Image (optional)</label>
        <input type="text" id="article-image" placeholder="Paste image URL" class="w-full px-2 py-1 border border-gray-400 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white text-gray-800">
      </div>
      <div>
        <label for="article-title" class="block font-medium mb-1 text-gray-700">Title</label>
        <input type="text" id="article-title" required class="w-full px-2 py-1 border border-gray-400 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white text-gray-800">
      </div>
      <div>
        <label for="article-author" class="block font-medium mb-1 text-gray-700">Author</label>
        <input type="text" id="article-author" required class="w-full px-2 py-1 border border-gray-400 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white text-gray-800">
      </div>
      <div>
        <label for="article-content" class="block font-medium mb-1 text-gray-700">Content</label>
        <textarea id="article-content" rows="6" placeholder="Write the article content here" class="w-full px-2 py-1 border border-gray-400 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white text-gray-800"></textarea>
      </div>
      <div>
        <label for="article-url" class="block font-medium mb-1 text-gray-700">Source URL (optional)</label>
        <input type="url" id="article-url" class="w-full px-2 py-1 border border-gray-400 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white text-gray-800">
      </div>
      <div>
        <label for="article-password" class="block font-medium mb-1 text-gray-700">Password (optional)</label>
        <input type="password" id="article-password" placeholder="Set a password for this article" class="w-full px-2 py-1 border border-gray-400 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white text-gray-800">
      </div>
      <div class="pt-2">
        <button id="submit-btn" type="submit" class="w-full bg-indigo-600 text-white py-2 px-3 rounded-md hover:bg-indigo-700 transition duration-200">Add Article</button>
      </div>
    </form>
  </div>
</div>

<!-- Details Modal -->
<div id="details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-gray-100 rounded-lg p-6 w-full max-w-4xl shadow-lg max-h-[80vh] overflow-y-auto relative">
    <button onclick="closeDetailsModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
      <i data-feather="x"></i>
    </button>
    <div class="flex flex-col md:flex-row gap-6">
      <div class="w-full md:w-1/3 flex-shrink-0">
        <img id="details-image" src="" alt="" class="rounded-md shadow w-full h-auto object-cover">
      </div>
      <div class="flex flex-col w-full md:w-2/3">
        <div class="mb-4">
          <h3 id="details-title" class="text-2xl font-bold text-indigo-700 mb-1"></h3>
          <p id="details-author" class="text-gray-700 mb-3 text-sm"></p>
          <div id="details-link" class="mb-4"></div>
        </div>
        <div class="overflow-y-auto" style="max-height: calc(80vh - 150px);">
          <h4 class="text-gray-800 font-semibold mb-2">Content</h4>
          <p id="details-content" class="text-gray-700 leading-relaxed whitespace-pre-line"></p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
AOS.init(); feather.replace();

const JSON_URL = "https://api.jsonbin.io/v3/b/68c0480043b1c97be93c9ab7/latest";
const JSON_WRITE_URL = "https://api.jsonbin.io/v3/b/68c0480043b1c97be93c9ab7";
let MASTER_KEY = "$2a$10$LpatGhcpooUYwqZyDAoGne9BvNAPwS4H3CyG5bUdLe7qnTfFbSdUC"; // optional for write access

let rooms = JSON.parse(localStorage.getItem('rooms') || '["General"]');
let articlesPerRoom = JSON.parse(localStorage.getItem('articlesPerRoom') || '{}');
rooms.forEach(r=>{ if(!articlesPerRoom[r]) articlesPerRoom[r]=[]; });
let currentRoom = rooms[0];
let editingIndex = null;

// DOM
const tabsContainer = document.getElementById('tabs-container');
const articlesContainer = document.getElementById('articles-container');
const emptyState = document.getElementById('empty-state');
const modal = document.getElementById('add-article-modal');
const articleForm = document.getElementById('article-form');
const modalTitle = document.getElementById('modal-title');
const submitBtn = document.getElementById('submit-btn');
const detailsModal = document.getElementById('details-modal');
const detailsTitle = document.getElementById('details-title');
const detailsAuthor = document.getElementById('details-author');
const detailsImage = document.getElementById('details-image');
const detailsContent = document.getElementById('details-content');
const detailsLink = document.getElementById('details-link');

function escapeHtml(str){return str?String(str).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])):"";}

async function fetchServer(){try{ const res=await fetch(JSON_URL); const data=await res.json(); return data.record || null;}catch(e){console.warn(e); return null;}}
async function saveServer(payload){if(!MASTER_KEY) return; try{ await fetch(JSON_WRITE_URL,{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':MASTER_KEY},body:JSON.stringify(payload)});}catch(e){console.error(e);}}

async function initialSync(){
  const serverData = await fetchServer();
  if(serverData && (serverData.rooms || serverData.articlesPerRoom)){
    rooms = serverData.rooms || Object.keys(serverData.articlesPerRoom||{});
    articlesPerRoom = serverData.articlesPerRoom || {};
    rooms.forEach(r=>{ if(!articlesPerRoom[r]) articlesPerRoom[r]=[]; });
    localStorage.setItem('rooms', JSON.stringify(rooms));
    localStorage.setItem('articlesPerRoom', JSON.stringify(articlesPerRoom));
  }
  renderTabs();
  displayArticles();
}

function persistState(){
  localStorage.setItem('rooms', JSON.stringify(rooms));
  localStorage.setItem('articlesPerRoom', JSON.stringify(articlesPerRoom));
  saveServer({rooms, articlesPerRoom});
}

// ---------- Tabs ----------
function renderTabs(){
  tabsContainer.innerHTML='';
  rooms.forEach(r=>{
    const btn = document.createElement('div');
    btn.className = `tab-btn ${r===currentRoom?'active':''}`;
    btn.innerHTML = `<span style="cursor:pointer" onclick="switchRoom('${r.replace(/'/g,"\\'")}')">${escapeHtml(r)}</span>
      <span class="tab-controls">
        <button onclick="renameRoom('${r.replace(/'/g,"\\'")}')">‚úèÔ∏è</button>
        <button onclick="deleteRoom('${r.replace(/'/g,"\\'")}')">üóëÔ∏è</button>
      </span>`;
    tabsContainer.appendChild(btn);
  });
}

function switchRoom(r){ currentRoom=r; renderTabs(); displayArticles(); }
function addNewRoom(){ const name=prompt("New room name"); if(!name || rooms.includes(name)) return; rooms.push(name); articlesPerRoom[name]=[]; persistState(); renderTabs(); displayArticles();}
function renameRoom(oldName){ const newName=prompt("New room name",oldName); if(!newName || rooms.includes(newName)) return; const idx=rooms.indexOf(oldName); rooms[idx]=newName; articlesPerRoom[newName]=articlesPerRoom[oldName]; delete articlesPerRoom[oldName]; if(currentRoom===oldName) currentRoom=newName; persistState(); renderTabs(); displayArticles();}
function deleteRoom(name){ if(!confirm("Delete room?")) return; const idx=rooms.indexOf(name); rooms.splice(idx,1); delete articlesPerRoom[name]; if(rooms.length===0){rooms=["General"]; articlesPerRoom["General"]=[];} if(currentRoom===name) currentRoom=rooms[0]; persistState(); renderTabs(); displayArticles();}

// ---------- Articles ----------
function displayArticles(){
  const arr = articlesPerRoom[currentRoom] || [];
  articlesContainer.innerHTML='';
  if(!arr.length){ emptyState.classList.remove('hidden'); return; } emptyState.classList.add('hidden');
  arr.forEach((a,i)=>{
    const card = document.createElement('div');
    card.className='article-card bg-gray-100 rounded-md overflow-hidden shadow-sm text-sm';
    card.setAttribute('data-index',i);
    card.setAttribute('draggable','true');
    card.addEventListener('dragstart', dragStart);
    card.addEventListener('dragover', dragOver);
    card.addEventListener('dragleave', dragLeave);
    card.addEventListener('drop', drop);
    card.addEventListener('dragend', dragEnd);
    const img = a.image || 'https://via.placeholder.com/320x480?text=No+Image';
    const lockIcon = a.password ? '<i data-feather="lock" class="w-3 h-3 inline-block ml-1"></i>':'';
    const snippet = a.content ? (a.content.slice(0,100)+(a.content.length>100?'...':'')):'';
    card.innerHTML=`<div class="article-image cursor-pointer" onclick="openDetails(${i})"><img src="${escapeHtml(img)}" class="w-full h-full object-cover"></div>
    <div class="p-2">
      <h3 class="font-semibold truncate cursor-pointer" onclick="openDetails(${i})">${escapeHtml(a.title)} ${lockIcon}</h3>
      <p class="text-gray-700 text-xs mb-1">${escapeHtml(a.author)}</p>
      <p class="article-snippet mb-2">${escapeHtml(snippet)}</p>
      <div class="flex justify-between items-center">
        ${a.url?`<a href="${escapeHtml(a.url)}" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-xs flex items-center"><i data-feather="link" class="w-3 h-3 mr-1"></i>Source</a>`:'<span></span>'}
        <div class="flex space-x-2">
          <button onclick="editArticle(${i})" class="text-blue-500 hover:text-blue-700 text-xs flex items-center"><i data-feather="edit-2" class="w-3 h-3 mr-1"></i>Edit</button>
          <button onclick="removeArticle(${i})" class="text-red-500 hover:text-red-700 text-xs flex items-center"><i data-feather="trash-2" class="w-3 h-3 mr-1"></i>Del</button>
        </div>
      </div>
    </div>`;
    articlesContainer.appendChild(card);
  });
  feather.replace();
}

// ---------- Drag & Drop ----------
let draggedIndex=null;
function dragStart(e){draggedIndex=parseInt(e.currentTarget.dataset.index); e.currentTarget.classList.add('dragging');}
function dragOver(e){e.preventDefault(); e.currentTarget.classList.add('drag-over');}
function dragLeave(e){e.currentTarget.classList.remove('drag-over');}
function drop(e){e.preventDefault(); const target=parseInt(e.currentTarget.dataset.index); if(draggedIndex===target) return; const arr=articlesPerRoom[currentRoom]; const moved=arr.splice(draggedIndex,1)[0]; arr.splice(target,0,moved); persistState(); displayArticles();}
function dragEnd(){document.querySelectorAll('.article-card').forEach(c=>c.classList.remove('dragging','drag-over')); draggedIndex=null;}

// ---------- Add/Edit ----------
articleForm.addEventListener('submit', e=>{
  e.preventDefault();
  const a={title:articleForm.querySelector('#article-title').value, author:articleForm.querySelector('#article-author').value, content:articleForm.querySelector('#article-content').value, image:articleForm.querySelector('#article-image').value, url:articleForm.querySelector('#article-url').value, password:articleForm.querySelector('#article-password').value};
  if(editingIndex!==null){ articlesPerRoom[currentRoom][editingIndex]=a; editingIndex=null; } else { articlesPerRoom[currentRoom].push(a); }
  persistState(); closeModal(); displayArticles(); articleForm.reset();
});

function removeArticle(i){ if(!confirm("Delete this article?")) return; articlesPerRoom[currentRoom].splice(i,1); persistState(); displayArticles();}
function editArticle(i){ const a=articlesPerRoom[currentRoom][i]; if(a.password){ const pw=prompt("Enter password to edit"); if(pw!==a.password){alert("Wrong password"); return;} } articleForm.querySelector('#article-title').value=a.title; articleForm.querySelector('#article-author').value=a.author; articleForm.querySelector('#article-content').value=a.content; articleForm.querySelector('#article-image').value=a.image; articleForm.querySelector('#article-url').value=a.url; articleForm.querySelector('#article-password').value=a.password; modalTitle.textContent='Edit Article'; submitBtn.textContent='Update'; editingIndex=i; openModal();}

// ---------- Details ----------
function openDetails(i){ const a=articlesPerRoom[currentRoom][i]; if(a.password){ const pw=prompt("Enter password to view"); if(pw!==a.password){alert("Wrong password"); return;} } detailsTitle.textContent=a.title; detailsAuthor.textContent=a.author?'by '+a.author:''; detailsContent.textContent=a.content||'No content.'; detailsImage.src=a.image||'https://via.placeholder.com/320x480?text=No+Image'; detailsLink.innerHTML=a.url?`<a href="${escapeHtml(a.url)}" target="_blank" class="inline-flex items-center px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm"><i data-feather="link" class="w-4 h-4 mr-2"></i>Source</a>`:'<p class="text-gray-500 text-sm">No link</p>'; detailsModal.classList.remove('hidden'); feather.replace();}
function closeDetailsModal(){detailsModal.classList.add('hidden');}

// ---------- Modal ----------
function openModal(){modal.classList.remove('hidden');}
function closeModal(){modal.classList.add('hidden'); modalTitle.textContent='Add New Article'; submitBtn.textContent='Add Article'; articleForm.reset(); editingIndex=null;}

// ---------- Auto-refresh ----------
setInterval(initialSync, 5000);
initialSync();
</script>
</body>
</html>
