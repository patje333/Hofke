<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VisualBoard Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leader-line-new/leader-line.min.js"></script>
<style>
body { margin:0; font-family: 'Inter', sans-serif; display:flex; height:100vh; overflow:hidden; background:#f4f5f7; }
aside { width:260px; background:#fff; padding:16px; box-shadow:2px 0 12px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
aside h2 { font-weight:700; font-size:1.2rem; margin-bottom:12px; }
aside .folders { flex:1; overflow-y:auto; }
aside .folder { padding:10px; cursor:pointer; border-radius:6px; margin-bottom:6px; transition:0.2s; }
aside .folder:hover { background:#e0e7ff; }
aside button { margin-top:8px; padding:8px; border:none; border-radius:6px; font-weight:500; cursor:pointer; transition:0.2s; }
aside button:hover { opacity:0.9; }

main { flex:1; overflow:auto; position:relative; }
.topbar { display:flex; align-items:center; gap:8px; padding:12px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.05); border-bottom:1px solid #e5e7eb; }
.boardContainer { width:2000px; height:1500px; position:relative; margin:10px; }

.note { position:absolute; width:260px; min-height:150px; background:#fff; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.12); display:flex; flex-direction:column; transition:0.2s; }
.note-header { display:flex; justify-content:space-between; align-items:center; padding:6px 10px; cursor:move; border-radius:8px 8px 0 0; font-weight:600; color:#fff; }
.note-toolbar { display:flex; flex-wrap:wrap; gap:4px; padding:4px 8px; background:#f9fafb; font-size:12px; border-bottom:1px solid #e5e7eb; }
.note-content { flex:1; padding:8px; overflow:auto; min-height:50px; outline:none; }
.preview { margin-top:4px; padding:4px; background:#f1f3f5; border-radius:4px; font-size:12px; border:1px solid #e5e7eb; }
.note button { cursor:pointer; border:none; background:none; font-weight:600; color:#374151; border-radius:4px; padding:2px 4px; transition:0.2s; }
.note button:hover { background:#e5e7eb; }
</style>
</head>
<body>

<aside>
<h2>Boards</h2>
<div class="folders" id="folders"></div>
<button id="addFolder" class="bg-indigo-600 text-white">+ Board</button>
<button id="saveBtn" class="bg-green-600 text-white">ðŸ’¾ Save</button>
<button id="loadBtn" class="bg-yellow-500 text-white">ðŸ“‚ Load</button>
</aside>

<main>
<div class="topbar">
<button id="addNote" class="bg-indigo-500 text-white rounded px-3 py-1">+ Note</button>
<button id="connectorToggle" class="bg-gray-200 rounded px-3 py-1">Connector</button>
<input type="color" id="arrowColor" value="#ff0000" title="Arrow Color">
<select id="arrowType">
<option value="straight">Straight</option>
<option value="dotted">Dotted</option>
<option value="arrow-small">Small Arrow</option>
</select>
</div>
<div class="boardContainer" id="boardContainer"></div>
</main>

<script>
const BIN_ID = '68c053e6d0ea881f40779ed8';
const SECRET_KEY = ''; // Add JSONBin secret if private

let boards = {}, activeBoard=null, firstNote=null, connectorMode=false, scale=1;

// Create Board
function createBoard(name){
  if(boards[name]) return;
  const board=document.createElement('div'); board.className='board'; board.style.display='none';
  boards[name]={element:board, connections:[]};
  document.getElementById('boardContainer').appendChild(board);
}

// Switch Board
function switchBoard(name){
  if(activeBoard) activeBoard.element.style.display='none';
  activeBoard = boards[name];
  activeBoard.element.style.display='block';
}

// Add Note
function addNote(text='', x=50, y=50, headerBg='#4f46e5'){
  if(!activeBoard) return alert('Select a board');
  const note=document.createElement('div'); note.className='note';
  note.style.left=x+'px'; note.style.top=y+'px';

  note.innerHTML=`
  <div class="note-header" style="background:${headerBg}">Note
    <div>
      <button class="minimize-btn">_</button>
      <input type="color" class="note-bg-picker" value="${headerBg}" title="Header Color">
    </div>
  </div>
  <div class="note-toolbar">
    <button onclick="execCmd(this,'bold')"><b>B</b></button>
    <button onclick="execCmd(this,'italic')"><i>I</i></button>
    <button onclick="execCmd(this,'underline')"><u>U</u></button>
    <button onclick="execCmd(this,'insertUnorderedList')">â€¢ List</button>
    <button onclick="execCmd(this,'insertOrderedList')">1. List</button>
    <button onclick="insertLink()">URL</button>
    <select onchange="execCmd(this,'fontSize',this.value)">
      <option value="3">Normal</option>
      <option value="4">Medium</option>
      <option value="5">Large</option>
    </select>
    <input type="color" onchange="execCmd(this,'foreColor',this.value)" title="Text Color">
  </div>
  <div class="note-content" contenteditable="true">${text}</div>
  <div class="preview"></div>
  `;

  activeBoard.element.appendChild(note);
  const header = note.querySelector('.note-header');
  const toolbar = note.querySelector('.note-toolbar');
  const contentDiv = note.querySelector('.note-content');

  // Draggable & resizable
  interact(note).draggable({ allowFrom: header, listeners:{ move: dragMoveListener } })
               .resizable({ edges:{left:true,right:true,bottom:true,top:true}, listeners:{ move: resizeMoveListener } });

  // Minimize closes entire note
  note.querySelector('.minimize-btn').onclick = () => note.remove();

  // Header color picker only changes header
  note.querySelector('.note-bg-picker').oninput = (e) => header.style.backgroundColor=e.target.value;

  // Toolbar only affects selected text
  toolbar.querySelectorAll('button, select, input[type=color]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      if(window.getSelection().isCollapsed && btn.tagName!=='BUTTON'){ e.preventDefault(); }
    });
  });

  note.onclick=()=>handleConnectorClick(note);

  contentDiv.addEventListener('input',()=>generatePlaceholderPreview(contentDiv,note.querySelector('.preview')));
  generatePlaceholderPreview(contentDiv,note.querySelector('.preview'));
}

// URL Screenshot
async function insertLink(){
    const url = prompt('Enter URL:');
    if(!url) return;
    const screenshotURL = `https://api.thumbnail.ws/api/ab89602da8af794219b32861186c55d30fc6737e2b55/thumbnail/get?url=${encodeURIComponent(url)}&width=480`;
    if(!activeBoard) return alert('Select a board');
    const div = document.createElement('div'); div.className='note'; div.style.left='100px'; div.style.top='100px'; div.style.width='320px'; div.style.height='240px';
    div.innerHTML=`
    <div class="note-header" style="background:#4f46e5">URL Preview
      <button class="minimize-btn">_</button>
      <input type="color" class="note-bg-picker" value="#4f46e5" title="Header Color">
    </div>
    <div style="flex:1; overflow:hidden; display:flex; flex-direction:column; align-items:center; justify-content:center;">
      <img src="${screenshotURL}" style="width:100%; height:70%; object-fit:cover; border-radius:4px;" />
      <p style="font-size:12px; word-break:break-word; margin-top:4px;">${url}</p>
    </div>`;
    activeBoard.element.appendChild(div);
    const header = div.querySelector('.note-header');
    interact(div).draggable({ allowFrom: header, listeners:{ move: dragMoveListener } })
                .resizable({ edges:{left:true,right:true,bottom:true,top:true}, listeners:{ move: resizeMoveListener } });
    div.querySelector('.minimize-btn').onclick = () => div.remove();
    div.querySelector('.note-bg-picker').oninput = (e)=>header.style.backgroundColor=e.target.value;
}

// Placeholder preview
function generatePlaceholderPreview(contentDiv,preview){
  const urlRegex=/(https?:\/\/[^\s]+)/g;
  const urls=contentDiv.innerText.match(urlRegex);
  preview.innerHTML='';
  if(urls) urls.forEach(url=>{
    const div=document.createElement('div');
    div.innerHTML=`<strong>Preview Title</strong><br>${url}<br><em>Placeholder description</em>`;
    preview.appendChild(div);
  });
}

// Drag & Resize
function dragMoveListener(e){ const t=e.target; const x=(parseFloat(t.getAttribute('data-x'))||0)+e.dx/scale; const y=(parseFloat(t.getAttribute('data-y'))||0)+e.dy/scale; t.style.transform=`translate(${x}px,${y}px)`; t.setAttribute('data-x',x); t.setAttribute('data-y',y); if(activeBoard) activeBoard.connections.forEach(c=>c.position()); }
function resizeMoveListener(e){ const t=e.target; let w=parseFloat(t.style.width)||t.offsetWidth; let h=parseFloat(t.style.height)||t.offsetHeight; w+=e.deltaRect.width; h+=e.deltaRect.height; t.style.width=w+'px'; t.style.height=h+'px'; }

// Connector
function handleConnectorClick(note){ if(!connectorMode) return; if(!firstNote){ firstNote=note; note.style.border='2px dashed red'; } else{ const color=document.getElementById('arrowColor').value||'red'; const type=document.getElementById('arrowType').value; const opts={color:color,path:'straight',startPlug:type.includes('arrow')?'disc':null}; const line=new LeaderLine(firstNote,note,opts); activeBoard.connections.push(line); firstNote.style.border=''; firstNote=null; } }

// Zoom
document.addEventListener('wheel',e=>{ if(e.ctrlKey){ e.preventDefault(); scale+=e.deltaY<0?0.05:-0.05; scale=Math.min(Math.max(scale,0.5),3); if(activeBoard) activeBoard.element.style.transform=`scale(${scale})`; }},{passive:false});

// Folders
document.getElementById('addFolder').onclick=()=>{
  const name=prompt('Board name:'); if(!name) return;
  createBoard(name);
  const folder=document.createElement('div'); folder.className='folder'; folder.textContent=name;
  folder.onclick=()=>switchBoard(name);
  document.getElementById('folders').appendChild(folder);
  switchBoard(name);
};

document.getElementById('addNote').onclick=()=>addNote();
document.getElementById('connectorToggle').onclick=()=>{connectorMode=!connectorMode; alert('Connector mode: '+connectorMode);}

// Rich text
function execCmd(el,cmd,val=null){ document.execCommand(cmd,false,val); }

// JSONBin save/load
async function saveBoards(){
  const boardsData={};
  Object.keys(boards).forEach(name=>{
    const b=boards[name];
    boardsData[name]={ notes:Array.from(b.element.querySelectorAll('.note')).map(n=>({
      html:n.querySelector('.note-content')?.innerHTML||'',
      x:parseFloat(n.getAttribute('data-x'))||0,
      y:parseFloat(n.getAttribute('data-y'))||0,
      headerBg:n.querySelector('.note-header')?.style.backgroundColor||'#4f46e5'
    }))};
  });
  await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`,{
    method:'PUT',
    headers:{ 'Content-Type':'application/json', 'X-Master-Key':SECRET_KEY, 'X-Bin-Versioning':'false' },
    body:JSON.stringify({boards:boardsData})
  });
  alert('Saved!');
}
async function loadBoards(){
  const res=await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`,{headers:{'X-Master-Key':SECRET_KEY}});
  const data=await res.json();
  const boardsData=data.record.boards||{};
  document.getElementById('boardContainer').innerHTML='';
  document.getElementById('folders').innerHTML='';
  boards={}; activeBoard=null;
  Object.keys(boardsData).forEach(name=>{
    createBoard(name);
    const folder=document.createElement('div'); folder.className='folder'; folder.textContent=name;
    folder.onclick=()=>switchBoard(name); document.getElementById('folders').appendChild(folder);
    switchBoard(name);
    boardsData[name].notes.forEach(n=>addNote(n.html,n.x,n.y,n.headerBg));
  });
}
document.getElementById('saveBtn').onclick=saveBoards;
document.getElementById('loadBtn').onclick=loadBoards;
</script>

</body>
</html>
